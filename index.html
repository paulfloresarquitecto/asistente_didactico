<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Didáctico IA para Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --bg-dark: #181818;
            --bg-card: #1e1e1e;
            --border-color: #374151;
            --text-light: #f3f4f6;
            --text-muted: #9ca3af;
            --accent-purple: #b217e6;
            --accent-purple-hover: #9e15cc;
            --accent-red: #ef4444;
            --accent-red-hover: #dc2626;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-purple);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        [data-tooltip] { position: relative; }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--border-color);
            color: var(--text-light);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 10;
        }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }

        #final-document-content { background-color: #ffffff; color: #111827; border-color: #d1d5db; }
        #final-document-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #111827; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        #final-document-content p { margin-bottom: 1rem; line-height: 1.6; }
        #final-document-content ul, #final-document-content ol { margin-left: 1.25rem; margin-bottom: 1rem; }
        #final-document-content li { margin-bottom: 0.5rem; }
        #final-document-content ul { list-style-type: disc; }
        #final-document-content ol { list-style-type: decimal; }
        #final-document-content pre { background-color: #f3f4f6; border: 1px solid #e5e7eb; color: #1f2937; font-family: 'Courier New', Courier, monospace; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }

        .print-only {
            display: none;
        }

        @media print {
            body { background-color: #fff; }
            body * { visibility: hidden; }
            #final-document-content, #final-document-content * { visibility: visible; }
            #final-document-content { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 1.5rem; border: none; }
            .no-print { display: none; }
            .print-only { display: flex; }
            .print-only a { text-decoration: none; color: #4b5563; }
        }
    </style>
</head>
<body class="bg-[var(--bg-dark)] flex items-center justify-center min-h-screen py-10">
    <div id="main-card" class="bg-[var(--bg-card)] rounded-2xl shadow-xl p-8 max-w-4xl w-full m-4">
        
        <div class="flex justify-end items-center gap-2 mb-4 no-print">
            <span class="text-sm text-[var(--text-muted)]">diseñado por:</span>
            <a href="https://paulflores.com.mx" target="_blank" rel="noopener noreferrer">
                <img src="https://paulflores.com.mx/wp-content/uploads/2025/04/pflores-logo.png" alt="Logo Paul Flores" class="h-8">
            </a>
        </div>

        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[var(--text-light)]">Asistente Didáctico IA</h1>
            <p class="text-[var(--text-muted)] mt-2">Paso 1: Sube o graba un audio de tu clase.</p>
        </div>

        <div class="bg-[var(--bg-dark)] p-6 rounded-lg border border-[var(--border-color)]">
            <div id="upload-area" class="text-center">
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                    <label for="media-file" class="cursor-pointer inline-block bg-[var(--accent-purple)] text-[var(--text-light)] font-bold p-3 rounded-lg hover:bg-[var(--accent-purple-hover)] transition-all duration-300 shadow-md" data-tooltip="Subir Archivo de Audio" aria-label="Subir Archivo de Audio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    </label>
                    <span class="text-[var(--text-muted)] font-medium">ó</span>
                    <button id="record-btn" class="cursor-pointer inline-block bg-[var(--border-color)] text-[var(--text-light)] font-bold p-3 rounded-lg hover:bg-gray-600 transition-all duration-300 shadow-md" data-tooltip="Grabar Audio" aria-label="Grabar Audio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4zm5 6a1 1 0 11-2 0V4a1 1 0 112 0v6zM10 15a5 5 0 005-5H5a5 5 0 005 5z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <input type="file" id="media-file" class="hidden" accept="audio/*">
                <p id="file-name" class="mt-4 text-[var(--text-muted)] font-medium h-5"></p>
            </div>
            
            <div id="recording-controls" class="hidden text-center">
                 <button id="stop-record-btn" class="cursor-pointer inline-block bg-[var(--accent-red)] text-[var(--text-light)] font-bold p-3 rounded-lg hover:bg-[var(--accent-red-hover)] transition-all duration-300 shadow-md" data-tooltip="Detener Grabación" aria-label="Detener Grabación">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                 </button>
                 <p id="timer" class="mt-4 text-2xl font-mono text-[var(--text-muted)]">00:00</p>
            </div>

            <div class="mt-6 text-center">
                <button id="transcribe-btn" class="bg-[var(--accent-purple)] text-[var(--text-light)] font-bold py-3 px-8 rounded-lg hover:bg-[var(--accent-purple-hover)] transition-all duration-300 shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center mx-auto" disabled data-tooltip="Transcribir" aria-label="Transcribir">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    <span class="sm:inline ml-2">Transcribir</span>
                </button>
            </div>
            <div id="transcription-loader" class="hidden flex flex-col items-center justify-center p-6">
                <div class="loader"></div>
                <p class="mt-4 text-[var(--text-muted)]">Transcribiendo audio, esto puede tardar unos minutos...</p>
            </div>
            <div id="status-message-area" class="mt-4 text-center"></div>
        </div>

        <div id="result-area" class="hidden mt-8">
            <h2 class="text-xl font-semibold text-[var(--text-light)] mb-4">Paso 2: Revisa la transcripción.</h2>
            <textarea id="transcription-text" class="w-full h-64 p-4 border border-[var(--border-color)] rounded-lg bg-[var(--bg-dark)] text-[var(--text-light)] focus:ring-2 focus:ring-[var(--accent-purple)] focus:border-[var(--accent-purple)]"></textarea>
        </div>

        <div id="didactic-tools-area" class="hidden mt-8 text-center">
             <h2 class="text-xl font-semibold text-[var(--text-light)] mb-4">Paso 3: Crea el material.</h2>
             <button id="generate-document-btn" class="bg-[var(--accent-purple)] text-[var(--text-light)] font-bold py-3 px-8 rounded-lg hover:bg-[var(--accent-purple-hover)] transition-all duration-300 shadow-md flex items-center justify-center mx-auto" data-tooltip="Generar Documento de Estudio" aria-label="Generar Documento de Estudio">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span class="sm:inline ml-2">Generar Documento</span>
            </button>
        </div>

        <div id="output-area" class="hidden mt-8">
            <div id="document-container">
                <div class="flex justify-between items-center mb-4 no-print">
                    <h2 class="text-2xl font-bold text-[var(--text-light)]">Documento Final</h2>
                    <div class="flex space-x-2">
                        <button id="print-pdf-btn" class="bg-[var(--border-color)] text-[var(--text-light)] font-semibold p-3 rounded-md hover:bg-gray-600 transition" data-tooltip="Imprimir a PDF" aria-label="Imprimir a PDF">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                        </button>
                        <button id="copy-document-btn" class="bg-[var(--border-color)] text-[var(--text-light)] font-semibold p-3 rounded-md hover:bg-gray-600 transition" data-tooltip="Copiar Todo" aria-label="Copiar Todo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                    </div>
                </div>
                <p id="copy-document-feedback" class="text-sm text-green-400 h-4 text-right"></p>
                <div id="generation-spinner" class="hidden flex flex-col items-center justify-center p-10">
                    <div class="loader"></div>
                    <p class="mt-4 text-[var(--text-muted)]">Generando documento, esto puede tardar un momento...</p>
                </div>
                <div id="final-document-content" class="p-6 border rounded-lg"></div>
            </div>
        </div>
    </div>

    <script>
    window.addEventListener('load', () => {
        // --- CONFIGURACIÓN DE DESARROLLO ---
        // Para probar en esta interfaz, pega tu API key aquí.
        // Para la versión en vivo (Netlify), esta variable se ignora.
        const DEV_CONFIG = { API_KEY: "" };

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const mediaFileInput = document.getElementById('media-file');
        const fileNameDisplay = document.getElementById('file-name');
        const transcribeBtn = document.getElementById('transcribe-btn');
        const transcriptionLoader = document.getElementById('transcription-loader');
        const statusMessageArea = document.getElementById('status-message-area');
        const resultArea = document.getElementById('result-area');
        const transcriptionText = document.getElementById('transcription-text');
        const didacticToolsArea = document.getElementById('didactic-tools-area');
        const generateDocumentBtn = document.getElementById('generate-document-btn');
        const uploadArea = document.getElementById('upload-area');
        const recordingControls = document.getElementById('recording-controls');
        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const timerDisplay = document.getElementById('timer');
        const outputArea = document.getElementById('output-area');
        const generationSpinner = document.getElementById('generation-spinner');
        const documentContainer = document.getElementById('document-container');
        const finalDocumentContent = document.getElementById('final-document-content');
        const copyDocumentBtn = document.getElementById('copy-document-btn');
        const copyDocumentFeedback = document.getElementById('copy-document-feedback');
        const printPdfBtn = document.getElementById('print-pdf-btn');

        // --- ESTADO DE LA APLICACIÓN ---
        let audioBase64 = null;
        let audioMimeType = null;
        const FILE_SIZE_LIMIT_MB = 100;
        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;

        // --- FUNCIONES DE UTILIDAD Y API ---
        function showStatusMessage(message, type = 'error') {
            const color = type === 'error' ? 'text-red-500' : 'text-green-500';
            statusMessageArea.innerHTML = `<p class="${color} font-semibold">${message}</p>`;
        }

        function setUiLoading(isLoading, type, message = '') {
            const btn = type === 'transcribe' ? transcribeBtn : generateDocumentBtn;
            if (btn) btn.disabled = isLoading;

            if (type === 'transcribe') {
                transcriptionLoader.classList.toggle('hidden', !isLoading);
                if(transcriptionLoader.querySelector('p')) transcriptionLoader.querySelector('p').textContent = message;
            } else if (type === 'generate') {
                generationSpinner.classList.toggle('hidden', !isLoading);
                finalDocumentContent.classList.toggle('hidden', isLoading);
            }

            if (isLoading) {
                statusMessageArea.innerHTML = '';
                if(type === 'transcribe'){
                    resultArea.classList.add('hidden');
                    didacticToolsArea.classList.add('hidden');
                    outputArea.classList.add('hidden');
                }
            }
        }
        
       async function callGenerativeAPI(prompt, inlineData = null) {
            const isProduction = window.location.hostname.includes('netlify.app');

            if (isProduction) {
                const apiUrl = `/.netlify/functions/gemini`;
                const payload = { prompt, inlineData };
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    throw new Error(`El servidor devolvió una respuesta inesperada. Código: ${response.status}`);
                }

                if (!response.ok) {
                    throw new Error(result.error || `Error en el servidor: ${response.status}`);
                }
                
                return result.text;
            } 
            else {
                const apiKey = DEV_CONFIG.API_KEY;
                if (!apiKey) {
                    throw new Error("Para probar en esta interfaz, pega tu clave de API en la variable DEV_CONFIG.");
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const parts = [{ text: prompt }];
                if (inlineData) parts.push({ inlineData: inlineData });
                const payload = { contents: [{ parts: parts }] };
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || `Error en la API de Google: ${response.status}`);
                }
                
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            }
        }


        function formatMarkdownToHtml(text) {
             const lines = text.split('\n');
            let html = '';
            let inUnorderedList = false, inOrderedList = false, inCodeBlock = false;
            function closeOpenLists() {
                if (inUnorderedList) { html += '</ul>'; inUnorderedList = false; }
                if (inOrderedList) { html += '</ol>'; inOrderedList = false; }
            }
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('```')) {
                    closeOpenLists();
                    if (inCodeBlock) { html += '</pre>'; inCodeBlock = false; } 
                    else { html += '<pre>'; inCodeBlock = true; }
                    return;
                }
                if (inCodeBlock) {
                    html += line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n';
                    return;
                }
                if (trimmedLine.startsWith('## ')) {
                    closeOpenLists();
                    html += `<h3>${trimmedLine.substring(3)}</h3>`;
                } else if (trimmedLine.startsWith('* ')) {
                    if (inOrderedList) closeOpenLists();
                    if (!inUnorderedList) { html += '<ul>'; inUnorderedList = true; }
                    html += `<li>${trimmedLine.substring(2)}</li>`;
                } else if (trimmedLine.match(/^\d+\. /)) {
                    if (inUnorderedList) closeOpenLists();
                    if (!inOrderedList) { html += '<ol>'; inOrderedList = true; }
                    html += `<li>${trimmedLine.replace(/^\d+\. /, '')}</li>`;
                } else if (trimmedLine) {
                    closeOpenLists();
                    html += `<p>${trimmedLine}</p>`;
                }
            });
            closeOpenLists();
            if (inCodeBlock) html += '</pre>';
            return html;
        }

        // --- MANEJO DE ARCHIVOS DE AUDIO ---
        mediaFileInput.addEventListener('change', (event) => handleFile(event.target.files[0]));

        async function handleFile(file) {
            if (!file) return;
            resetUIState();
            await processAudioFile(file);
        }

        async function processAudioFile(file) {
            if (!file.type.startsWith('audio/')) {
                showStatusMessage('Formato de archivo no soportado. Por favor, sube un archivo de audio.', 'error');
                resetUIState();
                return;
            }

            if (file.size > FILE_SIZE_LIMIT_MB * 1024 * 1024) {
                showStatusMessage(`El archivo es demasiado grande. El límite es ${FILE_SIZE_LIMIT_MB} MB.`, 'error');
                return;
            }
            fileNameDisplay.textContent = `Archivo: ${file.name}`;
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const dataUrl = reader.result;
                    audioBase64 = dataUrl.split(',')[1];
                    audioMimeType = dataUrl.split(',')[0].split(':')[1].split(';')[0];
                    transcribeBtn.disabled = false;
                    resolve();
                };
                reader.onerror = (error) => {
                    showStatusMessage('Error al procesar el archivo de audio.', 'error');
                    reject(error);
                };
            });
        }

        function resetUIState() {
            resultArea.classList.add('hidden');
            didacticToolsArea.classList.add('hidden');
            outputArea.classList.add('hidden');
            statusMessageArea.innerHTML = '';
            transcriptionLoader.classList.add('hidden');
            fileNameDisplay.textContent = '';
            transcribeBtn.disabled = true;
            mediaFileInput.value = '';
        }

        // --- LÓGICA DE GRABACIÓN DE AUDIO ---
        recordBtn.addEventListener('click', async () => {
            if (!navigator.mediaDevices?.getUserMedia) {
                showStatusMessage('La grabación de audio no es soportada en este navegador.', 'error');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
            } catch (err) {
                showStatusMessage('Se necesita permiso para acceder al micrófono.', 'error');
            }
        });

        function startRecording(stream) {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                handleFile(new File([audioBlob], "grabacion.webm", { type: 'audio/webm' }));
                stream.getTracks().forEach(track => track.stop());
            });
            mediaRecorder.start();
            uploadArea.classList.add('hidden');
            recordingControls.classList.remove('hidden');
            startTimer();
        }

        stopRecordBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            uploadArea.classList.remove('hidden');
            recordingControls.classList.add('hidden');
            stopTimer();
        });

        function startTimer() {
            let seconds = 0;
            timerDisplay.textContent = '00:00';
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${secs}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }

        // --- LÓGICA DE TRANSCRIPCIÓN ---
        transcribeBtn.addEventListener('click', async () => {
            if (!audioBase64) {
                showStatusMessage('Por favor, selecciona o graba un archivo de audio válido.', 'error');
                return;
            }
            setUiLoading(true, 'transcribe', 'Transcribiendo...');
            try {
                const transcriptionPrompt = "Transcribe el siguiente audio. Devuelve únicamente el texto de la transcripción, sin incluir ninguna marca de tiempo (timestamps) o información adicional, solo el texto puro.";
                const transcription = await callGenerativeAPI(transcriptionPrompt, { mimeType: audioMimeType, data: audioBase64 });
                if (transcription) {
                    transcriptionText.value = transcription;
                    resultArea.classList.remove('hidden');
                    didacticToolsArea.classList.remove('hidden');
                } else {
                    throw new Error('No se pudo obtener la transcripción del audio.');
                }
            } catch (error) {
                showStatusMessage(`Error en transcripción: ${error.message}`, 'error');
            } finally {
                setUiLoading(false, 'transcribe');
            }
        });

        // --- LÓGICA DE GENERACIÓN DE DOCUMENTO ---
        generateDocumentBtn.addEventListener('click', async () => {
            outputArea.classList.remove('hidden');
            setUiLoading(true, 'generate', 'Generando documento...');

            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = today.toLocaleDateString('es-MX', options);

            const masterPrompt = `A partir de la siguiente transcripción, genera un documento de estudio y productividad. Sigue ESTRICTAMENTE el siguiente formato y orden, usando los encabezados de Markdown indicados.

## Documento de Estudio
Fecha: ${formattedDate}
Re-escribe la transcripción completa como un texto fluido y coherente. Elimina muletillas (ej. "este", "bueno", "eh"), repeticiones y frases incompletas.

## Mapa Mental
Crea un mapa mental en formato de diagrama de texto (ASCII art). Usa líneas como '├──', '└──', y '│'. Envuelve TODO el mapa mental dentro de un bloque de código de texto (\`\`\`text).

## Resumen Ejecutivo
Crea un resumen conciso de la clase en un solo párrafo.

## Puntos Clave
Extrae los 5 conceptos más importantes en una lista con viñetas (*).

## Glosario de Términos
Identifica un máximo de 5 términos técnicos. Para cada uno, provee una definición clara. Usa el formato de lista con viñetas, por ejemplo: * Término: Definición. No uses negritas ni ningún otro formato especial.

## Plan de Acción y Tareas
Identifica todas las tareas o acciones a realizar. Preséntalas como una lista de quehaceres con viñetas (*). Si no se mencionan, escribe "No se identificaron tareas en esta sesión."

## Próximos Eventos y Fechas Clave
Extrae cualquier fecha, evento o fecha límite. Lístalos claramente. Si no se mencionan, escribe "No se identificaron eventos o fechas clave."

## Preguntas de Repaso
Crea 3 preguntas de repaso en una lista numerada.

--- TRANSCRIPCIÓN ---
${transcriptionText.value}`;
            try {
                const fullDocument = await callGenerativeAPI(masterPrompt);
                if (fullDocument) {
                    const printableHeader = `
                        <div class="print-only flex justify-end items-center mb-6">
                            <a href="[https://paulflores.com.mx](https://paulflores.com.mx)" target="_blank" rel="noopener noreferrer" class="text-xs text-gray-600">
                                diseñado por: paulflores.com.mx
                            </a>
                        </div>`;
                    finalDocumentContent.innerHTML = printableHeader + formatMarkdownToHtml(fullDocument);
                } else {
                    throw new Error("La API no devolvió contenido.");
                }
            } catch (error) {
                showStatusMessage(`Error al generar documento: ${error.message}`, 'error');
                outputArea.classList.add('hidden');
            } finally {
                setUiLoading(false, 'generate');
            }
        });

        // --- EVENT LISTENERS PARA BOTONES DE ACCIÓN ---
        copyDocumentBtn.addEventListener('click', () => {
             const tempContainer = document.createElement('div');
             const contentToCopy = finalDocumentContent.cloneNode(true);
             const headerToRemove = contentToCopy.querySelector('.print-only');
             if(headerToRemove) {
                headerToRemove.remove();
             }
             
             // Forzar estilos para asegurar fondo blanco y texto negro al pegar
             tempContainer.style.position = 'absolute';
             tempContainer.style.left = '-9999px';
             tempContainer.style.backgroundColor = 'white';
             tempContainer.style.color = 'black';
             
             contentToCopy.querySelectorAll('*').forEach(el => {
                el.style.backgroundColor = 'white';
                el.style.color = 'black';
             });

             tempContainer.appendChild(contentToCopy);
             document.body.appendChild(tempContainer);

             const range = document.createRange();
             range.selectNode(tempContainer);
             window.getSelection().removeAllRanges();
             window.getSelection().addRange(range);
             try {
                document.execCommand('copy');
                copyDocumentFeedback.textContent = '¡Documento copiado!';
             } catch (err) {
                copyDocumentFeedback.textContent = 'Error al copiar';
             }
             window.getSelection().removeAllRanges();
             document.body.removeChild(tempContainer);
             setTimeout(() => { copyDocumentFeedback.textContent = ''; }, 2000);
        });

        printPdfBtn.addEventListener('click', () => { window.print(); });
    });
    </script>
</body>
</html>

