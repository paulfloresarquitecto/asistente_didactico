<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Audio a Texto y Asistente Didáctico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --bg-dark: #181818;
            --bg-card: #1e1e1e;
            --border-color: #374151;
            --text-light: #f3f4f6;
            --text-muted: #9ca3af;
            --accent-purple: #b217e6;
            --accent-purple-hover: #9e15cc;
            --accent-red: #ef4444;
            --accent-red-hover: #dc2626;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-purple);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #final-document-content {
            background-color: #ffffff;
            color: #111827;
            border-color: #d1d5db;
        }
        #final-document-content h3 {
            font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #111827; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;
        }
        #final-document-content p {
            margin-bottom: 1rem; line-height: 1.6;
        }
        #final-document-content ul, #final-document-content ol {
            margin-left: 1.25rem; margin-bottom: 1rem;
        }
        #final-document-content li {
            margin-bottom: 0.5rem;
        }
        #final-document-content ul {
            list-style-type: disc;
        }
        #final-document-content ol { list-style-type: decimal; }
        #final-document-content pre {
            background-color: #f3f4f6; border: 1px solid #e5e7eb; color: #1f2937; font-family: 'Courier New', Courier, monospace; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;
        }

        @media print {
            body { background-color: #fff; }
            body * { visibility: hidden; }
            #final-document-content, #final-document-content * {
                visibility: visible;
            }
            #final-document-content {
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 1.5rem; border: none;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-[var(--bg-dark)] flex items-center justify-center min-h-screen py-10">
    <div id="main-card" class="bg-[var(--bg-card)] rounded-2xl shadow-xl p-8 max-w-4xl w-full m-4">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[var(--text-light)]">Asistente Didáctico IA</h1>
            <p class="text-[var(--text-muted)] mt-2">Paso 1: Sube o graba el audio de tu clase.</p>
        </div>

        <div class="bg-[var(--bg-dark)] p-6 rounded-lg border border-[var(--border-color)]">
            <div id="upload-area" class="text-center">
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                    <label for="audio-file" class="cursor-pointer inline-block bg-[var(--accent-purple)] text-[var(--text-light)] font-bold py-3 px-6 rounded-lg hover:bg-[var(--accent-purple-hover)] transition-all duration-300 shadow-md w-full sm:w-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        Subir Archivo
                    </label>
                    <span class="text-[var(--text-muted)] font-medium">ó</span>
                    <button id="record-btn" class="cursor-pointer inline-block bg-[var(--border-color)] text-[var(--text-light)] font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition-all duration-300 shadow-md w-full sm:w-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 4.5a2.5 2.5 0 015 0v6a2.5 2.5 0 01-5 0V4.5z" /><path d="M10 15a5 5 0 005-5h-1a4 4 0 01-8 0H5a5 5 0 005 5z" /></svg>
                        Grabar Audio
                    </button>
                </div>
                <input type="file" id="audio-file" class="hidden" accept="audio/*">
                <p id="file-name" class="mt-4 text-[var(--text-muted)] font-medium"></p>
            </div>
            
            <div id="recording-controls" class="hidden text-center">
                 <button id="stop-record-btn" class="cursor-pointer inline-block bg-[var(--accent-red)] text-[var(--text-light)] font-bold py-3 px-6 rounded-lg hover:bg-[var(--accent-red-hover)] transition-all duration-300 shadow-md">
                    <svg xmlns="http://www.w.org/2000/svg" class="h-6 w-6 inline-block mr-2 animate-pulse" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zm1 5a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                    Detener Grabación
                </button>
                <p id="timer" class="mt-4 text-2xl font-mono text-[var(--text-muted)]">00:00</p>
            </div>

            <div class="mt-6 text-center">
                <button id="transcribe-btn" class="bg-[var(--accent-purple)] text-[var(--text-light)] font-bold py-3 px-8 rounded-lg hover:bg-[var(--accent-purple-hover)] transition-all duration-300 shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Transcribir</button>
            </div>
            <div id="transcription-loader" class="hidden flex flex-col items-center justify-center p-6">
                <div class="loader"></div>
                <p class="mt-4 text-[var(--text-muted)]">Transcribiendo audio, esto puede tardar unos minutos...</p>
            </div>
            <div id="status-message-area" class="mt-4 text-center"></div>
        </div>

        <div id="result-area" class="hidden mt-8">
            <h2 class="text-xl font-semibold text-[var(--text-light)] mb-4">Paso 2: Revisa y corrige la transcripción.</h2>
            <div class="relative"><textarea id="transcription-text" class="w-full h-32 p-4 border border-[var(--border-color)] rounded-lg bg-[var(--bg-dark)] text-[var(--text-light)] focus:ring-2 focus:ring-[var(--accent-purple)] focus:border-[var(--accent-purple)]"></textarea></div>
        </div>

        <div id="didactic-tools-area" class="hidden mt-8">
             <h2 class="text-xl font-semibold text-[var(--text-light)] mb-4 text-center">Paso 3: Crea el material de estudio.</h2>
             <div class="flex justify-center">
                 <button id="generate-document-btn" class="bg-[var(--accent-purple)] text-[var(--text-light)] font-bold py-3 px-8 rounded-lg hover:bg-[var(--accent-purple-hover)] transition-all duration-300 shadow-md">
                    Generar Documento de Estudio
                </button>
             </div>
        </div>

        <div id="output-area" class="hidden mt-8">
            <div id="document-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-[var(--text-light)]">Documento de Estudio</h2>
                    <div class="flex space-x-2 no-print">
                        <button id="print-pdf-btn" class="bg-[var(--border-color)] text-[var(--text-light)] font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path></svg>
                            Imprimir a PDF
                        </button>
                        <button id="copy-document-btn" class="bg-[var(--border-color)] text-[var(--text-light)] font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            Copiar Todo
                        </button>
                    </div>
                </div>
                <p id="copy-document-feedback" class="text-sm text-green-400 h-4 text-right"></p>
                <div id="final-document-content" class="p-6 border rounded-lg"></div>
            </div>
            
            <div id="generation-spinner" class="hidden flex flex-col items-center justify-center p-10">
                <div class="loader"></div>
                <p class="mt-4 text-[var(--text-muted)]">Generando documento, esto puede tardar un momento...</p>
            </div>
        </div>
    </div>

    <script>
    window.addEventListener('load', () => {
        // --- CONFIGURACIÓN ---
        const GOOGLE_API_KEY = "AIzaSyBO9K5nOq8X2QbJyDtJJPLXHskEtPdfbms";

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const audioFileInput = document.getElementById('audio-file');
        const fileNameDisplay = document.getElementById('file-name');
        const transcribeBtn = document.getElementById('transcribe-btn');
        const transcriptionLoader = document.getElementById('transcription-loader');
        const statusMessageArea = document.getElementById('status-message-area');
        const resultArea = document.getElementById('result-area');
        const transcriptionText = document.getElementById('transcription-text');
        const didacticToolsArea = document.getElementById('didactic-tools-area');
        const generateDocumentBtn = document.getElementById('generate-document-btn');
        const uploadArea = document.getElementById('upload-area');
        const recordingControls = document.getElementById('recording-controls');
        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const timerDisplay = document.getElementById('timer');
        
        const outputArea = document.getElementById('output-area');
        const generationSpinner = document.getElementById('generation-spinner');
        
        const documentContainer = document.getElementById('document-container');
        const finalDocumentContent = document.getElementById('final-document-content');
        const copyDocumentBtn = document.getElementById('copy-document-btn');
        const copyDocumentFeedback = document.getElementById('copy-document-feedback');
        const printPdfBtn = document.getElementById('print-pdf-btn');

        // --- ESTADO DE LA APLICACIÓN ---
        let audioFile = null;
        let audioBase64 = null;
        let audioMimeType = null;
        const FILE_SIZE_LIMIT_MB = 100;
        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;

        // --- FUNCIONES DE UTILIDAD Y API ---
        function showStatusMessage(message, type = 'error') {
            const color = type === 'error' ? 'text-red-500' : 'text-green-500';
            statusMessageArea.innerHTML = `<p class="${color} font-semibold">${message}</p>`;
        }

        function setUiLoading(isLoading, type) {
            if (type === 'transcribe') {
                transcribeBtn.disabled = isLoading;
                transcriptionLoader.classList.toggle('hidden', !isLoading);
                if(isLoading) {
                    statusMessageArea.innerHTML = '';
                    resultArea.classList.add('hidden');
                    didacticToolsArea.classList.add('hidden');
                    outputArea.classList.add('hidden');
                }
            } else if (type === 'generate') {
                generateDocumentBtn.disabled = isLoading;
                generationSpinner.classList.toggle('hidden', !isLoading);
                if(isLoading) {
                    outputArea.classList.remove('hidden');
                    documentContainer.classList.add('hidden');
                }
            }
        }

        function isApiKeyInvalid() {
            if (GOOGLE_API_KEY === "SU_API_KEY_VA_AQUI" || GOOGLE_API_KEY === "") {
                showStatusMessage("Error de configuración: Por favor, introduce tu clave de API de Google en el código.", 'error');
                return true;
            }
            return false;
        }
        
        async function callGeminiAPI(prompt, inlineData = null) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GOOGLE_API_KEY}`;
            const parts = [{ text: prompt }];
            if (inlineData) parts.push({ inlineData });
            const payload = { contents: [{ parts }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error?.message || `Error en la API: ${response.status}`);
            return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        function formatMarkdownToHtml(text) {
             const lines = text.split('\n');
            let html = '';
            let inUnorderedList = false, inOrderedList = false, inCodeBlock = false;
            
            function closeOpenLists() {
                if (inUnorderedList) { html += '</ul>'; inUnorderedList = false; }
                if (inOrderedList) { html += '</ol>'; inOrderedList = false; }
            }

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('```')) {
                    closeOpenLists();
                    if (inCodeBlock) { html += '</pre>'; inCodeBlock = false; } 
                    else { html += '<pre>'; inCodeBlock = true; }
                    return;
                }
                if (inCodeBlock) {
                    html += line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n';
                    return;
                }
                if (trimmedLine.startsWith('## ')) {
                    closeOpenLists();
                    html += `<h3>${trimmedLine.substring(3)}</h3>`;
                } else if (trimmedLine.startsWith('* ')) {
                    if (inOrderedList) closeOpenLists();
                    if (!inUnorderedList) { html += '<ul>'; inUnorderedList = true; }
                    html += `<li>${trimmedLine.substring(2)}</li>`;
                } else if (trimmedLine.match(/^\d+\. /)) {
                    if (inUnorderedList) closeOpenLists();
                    if (!inOrderedList) { html += '<ol>'; inOrderedList = true; }
                    html += `<li>${trimmedLine.replace(/^\d+\. /, '')}</li>`;
                } else if (trimmedLine) {
                    closeOpenLists();
                    html += `<p>${trimmedLine}</p>`;
                }
            });

            closeOpenLists();
            if (inCodeBlock) html += '</pre>';
            html = html.replace(/<pre>\s*<\/pre>/g, '');
            html = html.replace(/<\/ul>\s*<ul>/g, '');
            html = html.replace(/<\/ol>\s*<ol>/g, '');
            return html;
        }


        // --- MANEJO DE LA SELECCIÓN DE ARCHIVO ---
        audioFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            handleFile(file);
        });

        function handleFile(file) {
            if (file.size > FILE_SIZE_LIMIT_MB * 1024 * 1024) {
                showStatusMessage(`El archivo es demasiado grande. El límite es ${FILE_SIZE_LIMIT_MB} MB.`, 'error');
                audioFileInput.value = '';
                return;
            }

            audioFile = file;
            fileNameDisplay.textContent = `Archivo: ${audioFile.name}`;
            transcribeBtn.disabled = false;
            
            resetUIState();

            const reader = new FileReader();
            reader.readAsDataURL(audioFile);
            reader.onload = () => {
                const dataUrl = reader.result;
                audioBase64 = dataUrl.split(',')[1];
                audioMimeType = dataUrl.split(',')[0].split(':')[1].split(';')[0];
            };
            reader.onerror = () => showStatusMessage('Error al procesar el archivo.', 'error');
        }

        function resetUIState() {
             resultArea.classList.add('hidden');
            didacticToolsArea.classList.add('hidden');
            outputArea.classList.add('hidden');
            statusMessageArea.innerHTML = '';
            transcriptionLoader.classList.add('hidden');
        }

        // --- LÓGICA DE GRABACIÓN DE AUDIO ---
        recordBtn.addEventListener('click', async () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatusMessage('La grabación de audio no es soportada en este navegador.', 'error');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
            } catch (err) {
                showStatusMessage('Se necesita permiso para acceder al micrófono.', 'error');
            }
        });

        function startRecording(stream) {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const recordedFile = new File([audioBlob], "grabacion.webm", { type: 'audio/webm' });
                handleFile(recordedFile);

                stream.getTracks().forEach(track => track.stop());
            });
            
            mediaRecorder.start();
            uploadArea.classList.add('hidden');
            recordingControls.classList.remove('hidden');
            startTimer();
        }

        stopRecordBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            uploadArea.classList.remove('hidden');
            recordingControls.classList.add('hidden');
            stopTimer();
        });

        function startTimer() {
            let seconds = 0;
            timerDisplay.textContent = '00:00';
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${secs}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // --- LÓGICA DE TRANSCRIPCIÓN ---
        transcribeBtn.addEventListener('click', async () => {
            if (isApiKeyInvalid()) return;
            if (!audioBase64) {
                showStatusMessage('Por favor, selecciona o graba un archivo de audio válido.', 'error');
                return;
            }
            
            setUiLoading(true, 'transcribe');
            try {
                const transcriptionPrompt = "Transcribe el siguiente audio. Devuelve únicamente el texto de la transcripción, sin incluir ninguna marca de tiempo (timestamps) o información adicional, solo el texto puro.";
                const transcription = await callGeminiAPI(transcriptionPrompt, { mimeType: audioMimeType, data: audioBase64 });

                if (transcription) {
                    transcriptionText.value = transcription;
                    resultArea.classList.remove('hidden');
                    didacticToolsArea.classList.remove('hidden');
                } else {
                    throw new Error('No se pudo obtener la transcripción del audio.');
                }
            } catch (error) {
                showStatusMessage(`Error en transcripción: ${error.message}`, 'error');
            } finally {
                setUiLoading(false, 'transcribe');
            }
        });

        // --- LÓGICA DE GENERACIÓN DE DOCUMENTO ---
        generateDocumentBtn.addEventListener('click', async () => {
            if (isApiKeyInvalid()) return;
            setUiLoading(true, 'generate');
            
            const masterPrompt = `
                A partir de la siguiente transcripción de una clase de arquitectura, genera un documento de estudio completo y bien estructurado. El documento debe seguir ESTRICTAMENTE el siguiente formato y orden, usando los encabezados de Markdown indicados. No incluyas ninguna introducción, saludo o párrafo de presentación. Comienza directamente con el primer encabezado.
                ## Documento de Estudio
                Re-escribe la transcripción completa como un texto fluido y coherente. Elimina todas las muletillas (ej. "este", "bueno", "eh"), repeticiones, interrupciones y frases incompletas para que el texto se lea como un artículo bien redactado.
                ## Mapa Mental
                Crea un mapa mental en formato de diagrama de texto (ASCII art). Usa líneas como '├──', '└──', y '│' para mostrar la estructura jerárquica. Envuelve TODO el mapa mental dentro de un bloque de código de texto (\`\`\`text).
                ## Resumen Ejecutivo
                Crea un resumen conciso de la clase en un solo párrafo.
                ## Puntos Clave
                Extrae los 5 conceptos o ideas más importantes y preséntalos en una lista con viñetas (*).
                ## Glosario de Términos
                Identifica un máximo de 5 términos técnicos o conceptos clave de arquitectura mencionados en el texto. Para cada término, provee una definición clara y concisa en una lista de viñetas. Formato: * **Término:** Definición.
                ## Conclusión
                Elabora un párrafo de conclusión que sintetice los temas tratados.
                ## Preguntas de Repaso
                Crea 3 preguntas de repaso diseñadas para evaluar la comprensión del tema. Preséntalas en una lista numerada.
                --- TRANSCRIPCIÓN ---
                ${transcriptionText.value}
            `;
            
            try {
                const fullDocument = await callGeminiAPI(masterPrompt);
                if (fullDocument) {
                    finalDocumentContent.innerHTML = formatMarkdownToHtml(fullDocument);
                    documentContainer.classList.remove('hidden');
                } else {
                    throw new Error("La API no devolvió contenido.");
                }
            } catch (error) {
                showStatusMessage(`Error al generar documento: ${error.message}`, 'error');
            } finally {
                setUiLoading(false, 'generate');
            }
        });

        // --- EVENT LISTENERS PARA BOTONES DE ACCIÓN ---
        copyDocumentBtn.addEventListener('click', () => {
             const tempContainer = document.createElement('div');
             tempContainer.style.position = 'absolute';
             tempContainer.style.left = '-9999px';
             const contentToCopy = finalDocumentContent.cloneNode(true);
             contentToCopy.style.color = 'black';
             contentToCopy.querySelectorAll('*').forEach(el => el.style.color = 'black');
             tempContainer.appendChild(contentToCopy);
             document.body.appendChild(tempContainer);
             const range = document.createRange();
             range.selectNode(tempContainer);
             window.getSelection().removeAllRanges();
             window.getSelection().addRange(range);
             try {
                document.execCommand('copy');
                copyDocumentFeedback.textContent = '¡Documento copiado!';
             } catch (err) {
                copyDocumentFeedback.textContent = 'Error al copiar';
             }
             window.getSelection().removeAllRanges();
             document.body.removeChild(tempContainer);
             setTimeout(() => { copyDocumentFeedback.textContent = ''; }, 2000);
        });

        printPdfBtn.addEventListener('click', () => { 
            window.print();
        });
    });
    </script>
</body>
</html>
